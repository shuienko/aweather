<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>aweather | forecast for astrophotographers</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/favicon-512x512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root{
            --bg: #f7f9fc;
            --panel: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #2563eb;
            --border: #e5e7eb;
        }
        html, body { background: var(--bg); color: var(--text); }
        body, input, button, select, textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        /* Hide empty forecast box until data arrives */
        #weatherResult:empty { display: none; }
        /* Suggestions dropdown */
        #suggestions { position: absolute; left: 0; right: 0; top: calc(100% + 6px); z-index: 50; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.08); list-style: none; padding-left: 0; max-height: 340px; overflow: auto; }
        #suggestions li { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        #suggestions li:last-child { border-bottom: none; }
        #suggestions li:hover { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="mx-auto max-w-3xl px-4 py-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-semibold tracking-tight">aweather</h1>
            <p class="text-[15px] text-slate-500 mt-2">Minimal, focused forecast for astrophotographers</p>
        </header>

        <div class="relative flex gap-3 items-stretch">
            <div class="relative flex-1">
                <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/></svg>
                </div>
                <input id="city" type="text" value="%s" placeholder="Search city, region, country" oninput="fetchSuggestions(this.value)"
                       class="w-full rounded-xl border border-slate-200 bg-white/90 pl-10 pr-3 py-3 text-[15px] outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-100 placeholder:text-slate-400" />
                <ul id="suggestions" style="display:none;"></ul>
             </div>
             <div class="relative shrink-0 group">
                 <button id="geoBtn" onclick="useMyLocation()" aria-label="Use my location" aria-describedby="geoTip"
                         class="flex items-center justify-center rounded-full border border-slate-200 bg-white p-2 text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-200">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5 text-slate-600">
                         <circle cx="12" cy="12" r="3" stroke-width="2" />
                         <path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke-width="2" stroke-linecap="round" />
                     </svg>
                 </button>
                 <div id="geoTip" role="tooltip"
                      class="pointer-events-none absolute -bottom-1 left-1/2 -translate-x-1/2 translate-y-full whitespace-nowrap rounded-md bg-slate-900 text-white text-[11px] px-2.5 py-1 shadow-lg opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity">
                     Use my location
                     <div class="absolute -top-1 left-1/2 -translate-x-1/2 h-2 w-2 rotate-45 bg-slate-900"></div>
                 </div>
             </div>
            <button id="fetchBtn" onclick="fetchWeather()"
                    class="shrink-0 rounded-xl bg-blue-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-200">
                Get forecast
            </button>
        </div>

        <div id="error" style="display:none" class="mt-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">Error</div>

        <input type="hidden" id="latitude" value="%s">
        <input type="hidden" id="longitude" value="%s">

        <div id="forecastDetails" style="display:none" class="mt-4 text-center text-[15px] text-slate-600 font-medium"></div>

        <div class="mt-3">
            <div class="text-center">
                <div id="weatherResult" class="space-y-3"></div>
                <div id="loader" style="display:none" class="mt-3 text-center">
                    <div class="inline-block h-5 w-5 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"></div>
                </div>
            </div>
        </div>

        <section class="mt-8 rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="text-lg font-semibold mb-1">About</h2>
            <p class="text-slate-600 text-[15px] mt-1">aweather is a clean, ultra‑minimalist forecast for astrophotographers. It answers one question: <b>Is the weather good for astrophotography tonight, in the next 3 hours, or tomorrow?</b> No humidity, precipitation, pressure, or dew point — just cloud cover, wind speed, and a simple “ok” when conditions are good.</p>
        </section>

        <section class="mt-4 rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="text-lg font-semibold mb-1">Legend</h2>
            <pre class="text-[13px] md:text-[13.5px] leading-relaxed text-slate-700 mt-2 whitespace-pre overflow-x-auto">
<b>• hour</b>           - time of the day
<b>• ok?</b>            - status; "ok" = (cloud cover < 25%%) and (wind speed < 15 km/h)
<b>• temp</b>           - temperature in Celsius
<b>• moon</b>           - Moon illumination percentage
<b>• low, mid, high</b> - cloud cover percentage at different altitudes
<b>• wind</b>           - wind speed in km/h
<b>• gusts</b>          - wind gusts in km/h
<b>• seeing</b>         - seeing index (lower is better)
<b>• top info</b>       - date; rise/set time for Moon and Sun. "*" means next/previous day
            </pre>
        </section>

        <section class="mt-4 rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="text-lg font-semibold mb-2">Contact & Links</h2>
            <div class="text-slate-600 text-[15px] space-y-1">
                <div>• All information comes from <a class="text-blue-600 hover:underline" href="https://open-meteo.com/">Open‑Meteo.com</a> API.</div>
                <div>• Source code: <a class="text-blue-600 hover:underline" href="https://github.com/shuienko/aweather">GitHub</a> (pull requests welcome).</div>
                <div>• If you like this page, please consider supporting me using the button below. Thank you!</div>
            </div>
        </section>

        <footer class="mt-6 text-center text-sm text-slate-500">
            <form action="https://www.paypal.com/donate" method="post" target="_top" class="mb-3">
                <input type="hidden" name="hosted_button_id" value="R3TWPEY9X4YKA" />
                <button type="submit" aria-label="Donate with PayPal"
                        class="inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-white font-medium shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 text-white/90">
                        <path d="M12 21.35 10.55 20.03C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.54 0 3.04.99 3.57 2.36h.87C11.46 4.99 12.96 4 14.5 4 17 4 19 6 19 8.5c0 3.78-3.4 6.86-8.55 11.53L12 21.35z"/>
                    </svg>
                    Donate
                </button>
            </form>
            © aweather | <a class="text-blue-600 hover:underline" href="https://open-meteo.com/">Weather data by Open‑Meteo.com</a>
        </footer>
    </div>

    <script>
        // Attach event listeners after DOM is fully loaded
        document.addEventListener("DOMContentLoaded", function () {
            const cityNameInput = document.getElementById("city");
            const latitudeInput = document.getElementById("latitude");
            const longitudeInput = document.getElementById("longitude");
            const forecastDetails = document.getElementById("forecastDetails");
            const weatherResult = document.getElementById("weatherResult");

            cityNameInput.addEventListener("input", function(event) {
                if (event.inputType === "deleteContentBackward") {
                    cityNameInput.value = "";
                    latitudeInput.value = "";
                    longitudeInput.value = "";
                    document.getElementById('suggestions').style.display = 'none';
                    clearTimeout(debounceTimer);
                }
            });

            document.addEventListener('click', function(e) {
                const suggestions = document.getElementById('suggestions');
                const cityInput = document.getElementById('city');
                if (e.target !== cityInput && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            cityNameInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    fetchWeather();
                }
            });

            loadCookies();
        });

        // ---- Helper Functions (Outside DOMContentLoaded) ----

        // Fetch suggestions for city input
        let debounceTimer;
        function fetchSuggestions(query) {
            clearTimeout(debounceTimer);
            const suggestionsEl = document.getElementById('suggestions');
            debounceTimer = setTimeout(() => {

                if (!query || query.length < 2) {
                    suggestionsEl.style.display = 'none';
                    suggestionsEl.innerHTML = '';
                    return;
                }

                fetch('/suggestions?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        suggestionsEl.innerHTML = '';
                        if (data.length > 0) {
                            suggestionsEl.style.display = 'block';
                            data.forEach(function(item) {
                                const regions = [item.admin1, item.admin2, item.admin3, item.admin4]
                                    .filter(region => region && region.trim().length > 0)
                                    .join(', ');
                                const country = item.country && item.country.trim().length > 0 ? item.country : item.country_code;
                                const fullName = item.name + (regions ? ', ' + regions : '') + ', ' + country;

                                const li = document.createElement('li');
                                li.textContent = fullName;
                                li.onclick = function(e) {
                                    e.stopPropagation();
                                    document.getElementById("city").value = fullName;
                                    document.getElementById("latitude").value = item.latitude;
                                    document.getElementById("longitude").value = item.longitude;
                                    suggestionsEl.style.display = 'none';
                                    clearTimeout(debounceTimer);

                                    // Automatically fetch forecast when city is selected
                                    fetchWeather();
                                };
                                suggestionsEl.appendChild(li);
                            });
                        } else {
                            suggestionsEl.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching suggestions:', error);
                        suggestionsEl.style.display = 'none';
                    });
            }, 300);
        }

        // Fetch weather data
        function fetchWeather() {
            const cityNameInput = document.getElementById("city");
            const latitudeInput = document.getElementById("latitude");
            const longitudeInput = document.getElementById("longitude");
            const forecastDetails = document.getElementById("forecastDetails");
            const weatherResult = document.getElementById("weatherResult");
            const errorEl = document.getElementById("error");
            const loaderEl = document.getElementById("loader");
            const fetchBtn = document.getElementById("fetchBtn");

            const suggestionsEl = document.getElementById('suggestions');
            suggestionsEl.style.display = 'none';

            errorEl.style.display = 'none';
            errorEl.textContent = '';

            const cityName = cityNameInput.value;
            const latitude = latitudeInput.value;
            const longitude = longitudeInput.value;

            if (!latitude || !longitude || isNaN(latitude) || isNaN(longitude)) {
                errorEl.textContent = "Please select a valid suggestion from the list or use “Use my location”.";
                errorEl.style.display = 'block';
                return;
            }
            if (cityName && cityName.length < 2) {
                errorEl.textContent = "Please enter a city name with at least 2 characters.";
                errorEl.style.display = 'block';
                return;
            }

            const shortName = cityName ? cityName.split(",")[0].trim() : "My location";
            const country = (cityName && cityName.includes(",")) ? cityName.split(",").slice(-1)[0].trim() : "";

            forecastDetails.textContent = shortName + (country ? ", " + country : "") + "  |  " + latitude + ",  " + longitude;
            forecastDetails.style.display = "block";

            weatherResult.innerHTML = '';
            loaderEl.style.display = 'block';
            fetchBtn.disabled = true;
            fetchBtn.classList.add('uk-disabled');
            cityNameInput.disabled = true;

            fetch("/weather?lat=" + encodeURIComponent(latitude) + "&lon=" + encodeURIComponent(longitude))
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error fetching weather data: " + response.statusText);
                    }
                    return response.text();
                })
                .then(data => {
                    errorEl.style.display = 'none';
                    renderWeather(data);
                })
                .catch(error => {
                    console.error(error);
                    errorEl.textContent = "Failed to fetch weather data. Please try again later.";
                    errorEl.style.display = 'block';
                })
                .finally(() => {
                    loaderEl.style.display = 'none';
                    fetchBtn.disabled = false;
                    fetchBtn.classList.remove('uk-disabled');
                    cityNameInput.disabled = false;
                });

            const maxAge = "max-age=" + (365 * 24 * 60 * 60);
            const cityCookie = country ? (shortName + ", " + country) : shortName;
            document.cookie = "cityName=" + encodeURIComponent(cityCookie) + "; path=/; " + maxAge;
            document.cookie = "latitude=" + encodeURIComponent(latitude) + "; path=/; " + maxAge;
            document.cookie = "longitude=" + encodeURIComponent(longitude) + "; path=/; " + maxAge;
        }

        // Render weather text into per-day cards with centered headers
        function renderWeather(text) {
            const container = document.getElementById('weatherResult');
            container.innerHTML = '';

            if (!text || text.trim().length === 0) {
                return;
            }

            const dayBlocks = text.split(/\n{2,}/).map(s => s.trim()).filter(Boolean);

            dayBlocks.forEach(block => {
                const lines = block.split('\n');
                if (lines.length === 0) return;

                const dateLine = lines[0] || '';
                const sunMoonLine = lines[1] || '';
                const tableText = lines.slice(2).join('\n');
                const tableTextWithBlankLine = tableText.replace(/\n*$/, '\n\n');

                const card = document.createElement('div');
                card.className = 'rounded-xl border border-slate-200 bg-white px-4 py-3 text-[13.5px] shadow-sm';

                const header = document.createElement('div');
                header.className = 'text-center';

                const dateEl = document.createElement('div');
                dateEl.className = 'font-medium text-slate-700 font-mono';
                dateEl.textContent = dateLine;

                const sunMoonEl = document.createElement('div');
                sunMoonEl.className = 'text-slate-500 font-mono';
                sunMoonEl.textContent = sunMoonLine;

                header.appendChild(dateEl);
                header.appendChild(sunMoonEl);

                const preWrap = document.createElement('div');
                preWrap.className = 'mt-2 text-center overflow-x-auto';

                const pre = document.createElement('pre');
                pre.className = 'inline-block text-left font-mono whitespace-pre leading-relaxed max-w-full';
                pre.textContent = tableTextWithBlankLine;

                preWrap.appendChild(pre);

                card.appendChild(header);
                card.appendChild(preWrap);
                container.appendChild(card);
            });
        }

        // Load cookies into inputs on page load
        function loadCookies() {
            const cookies = document.cookie.split("; ");
            const cookieMap = {};
            cookies.forEach(cookie => {
                const [key, value] = cookie.split("=");
                cookieMap[key] = decodeURIComponent(value);
            });

            const cityNameInput = document.getElementById("city");
            const latitudeInput = document.getElementById("latitude");
            const longitudeInput = document.getElementById("longitude");

            if (cookieMap.cityName) {
                cityNameInput.value = cookieMap.cityName;
            }
            if (cookieMap.latitude) {
                latitudeInput.value = cookieMap.latitude;
            }
            if (cookieMap.longitude) {
                longitudeInput.value = cookieMap.longitude;
            }
        }

        // Geolocation: Use my location -> reverse geocode -> fill fields -> fetch
        function useMyLocation() {
            const errorEl = document.getElementById('error');
            const geoBtn = document.getElementById('geoBtn');
            const cityInput = document.getElementById('city');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const suggestionsEl = document.getElementById('suggestions');

            suggestionsEl.style.display = 'none';
            errorEl.style.display = 'none';
            errorEl.textContent = '';

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                errorEl.textContent = 'Using your location requires HTTPS. Please use the search box instead.';
                errorEl.style.display = 'block';
                return;
            }
            if (!('geolocation' in navigator)) {
                errorEl.textContent = 'Geolocation is not supported by your browser. Please use the search box instead.';
                errorEl.style.display = 'block';
                return;
            }

            const geoIcon = geoBtn.querySelector('svg');
            const originalAriaLabel = geoBtn.getAttribute('aria-label') || '';
            geoBtn.disabled = true;
            geoBtn.setAttribute('aria-label', 'Locating…');
            if (geoIcon) { geoIcon.classList.add('animate-spin'); }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);
                    latitudeInput.value = lat;
                    longitudeInput.value = lon;

                    try {
                        const resp = await fetch('https://geocoding-api.open-meteo.com/v1/reverse?latitude=' + encodeURIComponent(lat) + '&longitude=' + encodeURIComponent(lon));
                        if (resp.ok) {
                            const data = await resp.json();
                            if (data && data.results && data.results.length > 0) {
                                const item = data.results[0];
                                const regions = [item.admin1, item.admin2, item.admin3, item.admin4]
                                    .filter(region => region && region.trim().length > 0)
                                    .join(', ');
                                const country = item.country && item.country.trim().length > 0 ? item.country : item.country_code;
                                const fullName = item.name + (regions ? ', ' + regions : '') + ', ' + country;
                                cityInput.value = fullName;
                            } else {
                                cityInput.value = 'My location';
                            }
                        } else {
                            cityInput.value = 'My location';
                        }
                    } catch (e) {
                        cityInput.value = 'My location';
                    } finally {
                        geoBtn.disabled = false;
                        geoBtn.setAttribute('aria-label', originalAriaLabel || 'Use my location');
                        if (geoIcon) { geoIcon.classList.remove('animate-spin'); }
                        fetchWeather();
                    }
                },
                (err) => {
                    geoBtn.disabled = false;
                    geoBtn.setAttribute('aria-label', originalAriaLabel || 'Use my location');
                    if (geoIcon) { geoIcon.classList.remove('animate-spin'); }
                    let msg = '';
                    switch (err.code) {
                        case err.PERMISSION_DENIED:
                            msg = 'Location permission denied. You can use the search box instead.';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            msg = 'Unable to determine your location. Please try the search box.';
                            break;
                        case err.TIMEOUT:
                            msg = 'Timed out while trying to get your location. Please try again.';
                            break;
                        default:
                            msg = "Couldn't get your location. Please use the search box.";
                    }
                    errorEl.textContent = msg;
                    errorEl.style.display = 'block';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
    </script>
</body>
</html>